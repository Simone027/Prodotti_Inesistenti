<script>
    // Variabile globale per i prodotti
    let prodotti = [];

    // Elementi DOM
    const container = document.getElementById("products");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc = document.getElementById("modalDesc");
    const modalReviews = document.getElementById("modalReviews");
    const toggleBtn = document.getElementById("toggleTheme");
    const themeOptions = document.getElementById("themeOptions");
    const searchInput = document.getElementById("searchInput");
    const noResults = document.getElementById("noResults");
    const themeOptionsElements = document.querySelectorAll('.theme-option');

    // Carica i dati dal JSON
    async function loadProducts() {
        try {
            const response = await fetch('https://simone027.github.io/prodotti_inesistenti/database.json');
            const data = await response.json();
            prodotti = data.prodotti;
            renderProducts();
        } catch (error) {
            console.error('Errore nel caricamento dei prodotti:', error);
            // Mostra un messaggio di errore all'utente
            container.innerHTML = '<div class="no-results">Errore nel caricamento dei prodotti. Riprova più tardi.</div>';
        }
    }

    // Funzione per salvare la preferenza del tema
    function saveThemePreference(theme) {
      localStorage.setItem('themePreference', theme);
    }

    // Funzione per caricare la preferenza del tema
    function loadThemePreference() {
      return localStorage.getItem('themePreference') || 'auto';
    }

    // Funzione per impostare il tema
    function setTheme(theme) {
      // Rimuovi tutte le classi attive
      themeOptionsElements.forEach(option => {
        option.classList.remove('active');
      });
      
      // Imposta l'opzione attiva
      const activeOption = document.querySelector(`.theme-option[data-theme="${theme}"]`);
      if (activeOption) {
        activeOption.classList.add('active');
      }
      
      // Aggiorna l'icona del pulsante principale
      let icon;
      if (theme === 'auto') {
        icon = '🌓';
      } else if (theme === 'light') {
        icon = '☀️';
      } else {
        icon = '🌙';
      }
      toggleBtn.textContent = icon;
      
      // Applica il tema
      if (theme === 'auto') {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        document.body.classList.toggle('dark', prefersDark);
      } else {
        document.body.classList.toggle('dark', theme === 'dark');
      }
      
      // Salva la preferenza
      saveThemePreference(theme);
    }

    // Carica la preferenza del tema all'avvio
    const savedTheme = loadThemePreference();
    setTheme(savedTheme);

    // Ascolta i cambiamenti del tema di sistema (solo per modalità auto)
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", e => {
      if (loadThemePreference() === 'auto') {
        setTheme('auto');
      }
    });

    // Gestione del click sul pulsante del tema
    toggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      themeOptions.classList.toggle('show');
    });

    // Gestione della selezione delle opzioni del tema
    themeOptionsElements.forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.dataset.theme;
        setTheme(theme);
        themeOptions.classList.remove('show');
      });
    });

    // Chiudi il menu delle opzioni quando si clicca altrove
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.floating-theme-selector')) {
        themeOptions.classList.remove('show');
      }
    });

    // Creazione delle card prodotto
    function renderProducts(products = prodotti) {
      container.innerHTML = "";
      noResults.style.display = "none";
      
      if (products.length === 0) {
        noResults.style.display = "block";
        return;
      }
      
      products.forEach((prodotto) => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `<span>${prodotto.nome}</span>`;
        card.addEventListener("click", () => openModal(prodotto));
        container.appendChild(card);
      });
    }
    
    // Funzione per filtrare i prodotti
    function filterProducts() {
      const searchTerm = searchInput.value.toLowerCase();
      
      if (searchTerm.trim() === "") {
        renderProducts(prodotti);
        return;
      }
      
      const filteredProducts = prodotti.filter(prodotto => 
        prodotto.nome.toLowerCase().includes(searchTerm)
      );
      
      renderProducts(filteredProducts);
    }
    
    // Event listener per la ricerca
    searchInput.addEventListener("input", filterProducts);
    
    // Pulsante per cancellare la ricerca
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        searchInput.value = "";
        filterProducts();
      }
    });

    // Funzione per aprire la modale
    function openModal(prodotto) {
      modalTitle.textContent = prodotto.nome;
      modalDesc.textContent = prodotto.descrizione;
      modalReviews.innerHTML = "";
      
      prodotto.recensioni.forEach(r => {
        const div = document.createElement("div");
        div.className = "review";
        div.innerHTML = `
          <div class="review-user">${r.utente}</div>
          <div>${r.testo}</div>
          <div class="rating">${"★".repeat(r.stelle)}${"☆".repeat(5 - r.stelle)}</div>
        `;
        modalReviews.appendChild(div);
      });
      
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";
      themeOptions.classList.remove('show');
    }

    // Chiusura modale
    document.getElementById("closeModal").addEventListener("click", () => {
      modal.style.display = "none";
      document.body.style.overflow = "auto";
    });

    window.addEventListener("click", e => {
      if (e.target === modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });

    // Chiudi modal con ESC
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && modal.style.display === "flex") {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });

    // Inizializza la pagina caricando i prodotti
    loadProducts();
</script>
